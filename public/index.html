<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Marmoraria - Sistema de Gest√£o de Vendas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --color-primary: #2180a6;
            --color-primary-hover: #1a6b8a;
            --color-secondary: #5e5240;
            --color-success: #208d8d;
            --color-danger: #c01530;
            --color-warning: #a84b2f;
            --color-bg: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #133452;
            --color-text-light: #626c71;
            --color-border: rgba(94, 82, 64, 0.2);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* LAYOUT */
        .app-wrapper {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-primary);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        /* SIDEBAR NAV */
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background-color: rgba(33, 128, 166, 0.08);
            color: var(--color-primary);
        }

        .nav-item.active {
            background-color: rgba(33, 128, 166, 0.12);
            border-left-color: var(--color-primary);
            color: var(--color-primary);
            font-weight: 500;
        }

        .nav-section-title {
            padding: 16px 20px 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hidden {
            display: none !important;
        }

        /* BUTTONS */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-family);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-secondary {
            background-color: rgba(94, 82, 64, 0.12);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: rgba(94, 82, 64, 0.2);
        }

        .btn-danger {
            background-color: var(--color-danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* FORMS */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: var(--font-family);
            background-color: var(--color-surface);
            color: var(--color-text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 166, 0.1);
        }

        /* TABLES */
        .table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--color-surface);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .table thead th {
            background-color: rgba(33, 128, 166, 0.08);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
        }

        .table tbody td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
        }

        .table tbody tr:hover {
            background-color: rgba(33, 128, 166, 0.04);
        }

        /* CARDS */
        .card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--color-surface);
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-text-light);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 12px;
            border-top: 1px solid var(--color-border);
        }

        /* KPIS */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--color-text-light);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success { background-color: rgba(32, 141, 141, 0.15); color: var(--color-success); }
        .badge-warning { background-color: rgba(168, 75, 47, 0.15); color: var(--color-warning); }
        .badge-danger { background-color: rgba(192, 21, 47, 0.15); color: var(--color-danger); }
        .badge-info { background-color: rgba(33, 128, 166, 0.15); color: var(--color-primary); }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* RESPONSIVE ADJUSTMENTS */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            }
            .sidebar.active {
                left: 0;
            }
            .menu-toggle {
                display: block;
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .header {
                padding: 12px 15px;
            }
            .content {
                padding: 15px;
            }
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 576px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .table-responsive {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            .btn {
                padding: 10px 15px;
            }
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .sidebar-overlay.active {
            display: block;
        }

        /* PRINT STYLES */
        @media print {
            .sidebar, .header, .btn, .nav-section-title, .modal {
                display: none !important;
            }
            .main-content {
                display: block !important;
                overflow: visible !important;
            }
            .content {
                padding: 0 !important;
                overflow: visible !important;
            }
            .page {
                display: block !important;
            }
            #print-area {
                display: block !important;
            }
        }

        #print-area {
            display: none;
            padding: 40px;
            background: white;
        }

        .print-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .print-logo {
            max-height: 80px;
        }

        .print-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .print-section {
            margin-bottom: 20px;
        }

        .print-section-title {
            background: #f4f4f4;
            padding: 8px;
            font-weight: bold;
            margin-bottom: 10px;
            border-left: 4px solid var(--color-primary);
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleMobileMenu()"></div>
    <div class="app-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div style="padding: 0 20px 20px; border-bottom: 1px solid var(--color-border); margin-bottom: 10px;">
                <h1 style="font-size: 20px; color: var(--color-primary);">‚ö° Flash Marmoraria</h1>
                <p style="font-size: 12px; color: var(--color-text-light);">Sistema de Gest√£o v2.0</p>
            </div>

            <div class="nav-item active" onclick="showPageNav(this, 'dashboard')">üìä Dashboard</div>
            
            <div class="nav-section-title">Vendas</div>
            <div class="nav-item" onclick="showPageNav(this, 'simulador')">üìê Simulador / Or√ßamento</div>
            <div class="nav-item" onclick="showPageNav(this, 'orcamentos')">üìÑ Or√ßamentos Gerados</div>
            <div class="nav-item" onclick="showPageNav(this, 'vendas')">üí∞ Vendas Realizadas</div>

            <div class="nav-section-title">Operacional</div>
            <div class="nav-item" onclick="showPageNav(this, 'producao')">üèóÔ∏è Produ√ß√£o / O.S</div>
            <div class="nav-item" onclick="showPageNav(this, 'estoque')">üì¶ Estoque de Chapas</div>

            <div class="nav-section-title">Cadastros</div>
            <div class="nav-item" onclick="showPageNav(this, 'clientes')">üë• Clientes</div>
            <div class="nav-item" onclick="showPageNav(this, 'vendedores')">üëî Vendedores</div>
            <div class="nav-item" onclick="showPageNav(this, 'produtos')">üíé Materiais / Pre√ßos</div>

            <div class="nav-section-title">Administrativo</div>
            <div class="nav-item" onclick="showPageNav(this, 'financeiro')">üè¶ Financeiro</div>
            <div class="nav-item" onclick="showPageNav(this, 'usuarios')">üë§ Usu√°rios</div>
            <div class="nav-item" onclick="showPageNav(this, 'configuracoes')">‚öôÔ∏è Configura√ß√µes</div>

            <div style="margin-top: auto; padding: 20px; border-top: 1px solid var(--color-border);">
                <div style="font-size: 13px; margin-bottom: 10px;">
                    <span id="user-info">Admin</span>
                </div>
                <button class="btn btn-secondary btn-sm" style="width: 100%;" onclick="logout()">Sair</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">            <header class="header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
                    <h2 id="page-title">Dashboard</h2>
                </div>
                <div id="user-info" class="hidden">               <button class="btn btn-primary" onclick="showPageNav(null, 'simulador')">‚ûï Novo Or√ßamento</button>
                </div>
            </header>

            <div class="content">
                <!-- Login Page -->
                <div id="page-login" class="page hidden">
                    <div style="max-width: 400px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
                        <h2 style="text-align: center; margin-bottom: 30px;">Acesso ao Sistema</h2>
                        <form id="login-form">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="login-email" class="form-control" required value="admin@marmoraria.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Senha</label>
                                <input type="password" id="login-senha" class="form-control" required value="demo123">
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;">Entrar</button>
                        </form>
                    </div>
                </div>

                <!-- Dashboard -->
                <div id="page-dashboard" class="page">
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Vendas do M√™s</div>
                            <div class="kpi-value" id="kpi-vendas-mes">R$ 0,00</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Or√ßamentos Pendentes</div>
                            <div class="kpi-value" id="kpi-orc-pendentes">0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Em Produ√ß√£o</div>
                            <div class="kpi-value" id="kpi-producao">0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">A Receber</div>
                            <div class="kpi-value" id="kpi-receber" style="color: var(--color-success);">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">√öltimos Or√ßamentos</h3>
                                <button class="btn btn-sm btn-secondary" onclick="showPageNav(null, 'orcamentos')">Ver todos</button>
                            </div>
                            <div class="table-responsive"><table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Cliente</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-orcamentos"></tbody>
                            </table></div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Ranking Vendedores</h3>
                            </div>
                            <div class="table-responsive"><table class="table">
                                <thead>
                                    <tr>
                                        <th>Vendedor</th>
                                        <th>Vendas</th>
                                        <th>Meta</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-vendedores"></tbody>
                            </table></div>
                        </div>
                    </div>
                </div>

                <!-- Simulador -->
                <div id="page-simulador" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Dados do Cliente</h3>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Cliente</label>
                                <select id="simulador-cliente" class="form-control"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendedor</label>
                                <select id="simulador-vendedor" class="form-control"></select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Adicionar Pe√ßa / Ambiente</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div class="form-group">
                                    <label class="form-label">Ambiente (ex: Cozinha)</label>
                                    <input type="text" id="sim-ambiente" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Material</label>
                                    <select id="sim-material" class="form-control"></select>
                                </div>
                            </div>
                            <div id="visualizador-3d" style="width: 100%; height: 200px; background: #eee; border-radius: 8px; border: 1px solid var(--color-border); overflow: hidden; position: relative;">
                                <div style="position: absolute; top: 5px; left: 10px; font-size: 10px; font-weight: bold; color: var(--color-primary); z-index: 10;">VISTA 3D EM TEMPO REAL</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label class="form-label">Largura (m)</label>
                                <input type="number" id="sim-largura" class="form-control" step="0.01" onchange="gerarCamposIndividuais('bordas'); gerarCamposIndividuais('frontoes'); update3D();" oninput="update3D()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Altura/Prof (m)</label>
                                <input type="number" id="sim-altura" class="form-control" step="0.01" onchange="gerarCamposIndividuais('pes'); update3D();" oninput="update3D()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Qtd</label>
                                <input type="number" id="sim-qtd" class="form-control" value="1">
                            </div>
                        </div>

                        <div style="margin-top: 10px; padding: 15px; background: rgba(33, 128, 166, 0.05); border-radius: 8px;">
                            <h5 style="margin-bottom: 10px; color: var(--color-primary);">Detalhamento de Partes</h5>
                            
                            <!-- Bordas -->
                            <div style="margin-bottom: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Bordas (Qtd)</label>
                                    <select id="sim-bordas" class="form-control" onchange="gerarCamposIndividuais('bordas')">
                                        <option value="0">Nenhuma</option>
                                        <option value="1">1 Borda</option>
                                        <option value="2">2 Bordas</option>
                                        <option value="3">3 Bordas</option>
                                        <option value="4">4 Bordas</option>
                                    </select>
                                </div>
                                <div id="container-bordas-individuais" style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;"></div>
                            </div>

                            <!-- Front√µes -->
                            <div style="margin-bottom: 15px;">
                                <div class="form-group">
                                    <label class="form-label">Front√µes (Qtd)</label>
                                    <select id="sim-frontoes" class="form-control" onchange="gerarCamposIndividuais('frontoes')">
                                        <option value="0">Nenhum</option>
                                        <option value="1">1 Lado</option>
                                        <option value="2">2 Lados</option>
                                        <option value="3">3 Lados</option>
                                        <option value="4">4 Lados</option>
                                    </select>
                                </div>
                                <div id="container-frontoes-individuais" style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;"></div>
                            </div>

                            <!-- P√©s -->
                            <div style="margin-bottom: 15px;">
                                <div class="form-group">
                                    <label class="form-label">P√©s (Qtd)</label>
                                    <select id="sim-pes" class="form-control" onchange="gerarCamposIndividuais('pes')">
                                        <option value="0">Nenhum</option>
                                        <option value="1">1 P√©</option>
                                        <option value="2">2 P√©s</option>
                                    </select>
                                </div>
                                <div id="container-pes-individuais" style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;"></div>
                            </div>
                            <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">* Deixe "Largura" em branco para usar automaticamente a medida da pe√ßa.</p>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
                            <button class="btn btn-primary" style="min-width: 200px;" onclick="adicionarPeca()">‚ûï Adicionar Pe√ßa ao Or√ßamento</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>Ambiente</th>
                                    <th>Medidas</th>
                                    <th>Material</th>
                                    <th>Subtotal</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="simulador-itens"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align: right; font-weight: bold; padding: 15px;">TOTAL:</td>
                                    <td id="simulador-total" style="font-weight: bold; font-size: 18px; color: var(--color-primary);">R$ 0,00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table></div>
                        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn btn-secondary" onclick="state.simulador.pecas = []; renderSimulador();">Limpar</button>
                            <button class="btn btn-primary" onclick="gerarOrcamento()">Gerar Or√ßamento Final</button>
                        </div>
                    </div>
                </div>

                <!-- Clientes -->
                <div id="page-clientes" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Listagem de Clientes</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-cliente')">‚ûï Novo Cliente</button>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>Nome / Raz√£o</th>
                                    <th>CPF / CNPJ</th>
                                    <th>Telefone</th>
                                    <th>Endere√ßo</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="clientes-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Vendedores -->
                <div id="page-vendedores" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Equipe de Vendas</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-vendedor')">‚ûï Novo Vendedor</button>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Meta Mensal</th>
                                    <th>Comiss√£o (%)</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="vendedores-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Produtos -->
                <div id="page-produtos" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Tabela de Materiais</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-produto')">‚ûï Novo Material</button>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Cor</th>
                                    <th>Pre√ßo m¬≤</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="produtos-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Or√ßamentos -->
                <div id="page-orcamentos" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Hist√≥rico de Or√ßamentos</h3>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentos-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Vendas -->
                <div id="page-vendas" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Relat√≥rio de Vendas</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="relatorio-inicio" class="form-control">
                                <input type="date" id="relatorio-fim" class="form-control">
                                <button class="btn btn-secondary" onclick="gerarRelatorioVendas()">Filtrar</button>
                            </div>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>Data Venda</th>
                                    <th>Data Or√ß.</th>
                                    <th>Cliente</th>
                                    <th>Vendedor</th>
                                    <th>Total</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="vendas-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Produ√ß√£o -->
                <div id="page-producao" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Ordens de Servi√ßo em Aberto</h3>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>OS #</th>
                                    <th>Pedido #</th>
                                    <th>Status</th>
                                    <th>Previs√£o</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="producao-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Estoque -->
                <div id="page-estoque" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Controle de Chapas</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-chapa')">‚ûï Cadastrar Chapa</button>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>ID Chapa</th>
                                    <th>Material</th>
                                    <th>Medidas (cm)</th>
                                    <th>√Årea (m¬≤)</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="chapas-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Financeiro -->
                <div id="page-financeiro" class="page hidden">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Contas a Receber</h3>
                            </div>
                            <div class="table-responsive"><table class="table">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="receber-list"></tbody>
                            </table></div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Contas a Pagar</h3>
                                <button class="btn btn-sm btn-danger" onclick="openContaPagarModal()">‚ûï Nova Conta</button>
                            </div>
                            <div class="table-responsive"><table class="table">
                                <thead>
                                    <tr>
                                        <th>Fornecedor</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="pagar-list"></tbody>
                            </table></div>
                        </div>
                    </div>
                </div>

                <!-- Usuarios -->
                <div id="page-usuarios" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Gest√£o de Usu√°rios</h3>
                            <button class="btn btn-primary" onclick="openUsuarioModal()">‚ûï Novo Usu√°rio</button>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Perfil</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="usuarios-list"></tbody>
                        </table></div>
                    </div>
                </div>

                <!-- Configuracoes -->
                <div id="page-configuracoes" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Dados da Empresa</h3>
                            <button class="btn btn-primary" onclick="openModal('modal-empresa')">‚ûï Adicionar Empresa</button>
                        </div>
                        <div class="table-responsive"><table class="table">
                            <thead>
                                <tr>
                                    <th>Raz√£o Social</th>
                                    <th>CNPJ</th>
                                    <th>Plano</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="empresas-list"></tbody>
                        </table></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- √ÅREA DE IMPRESS√ÉO (OCULTA) -->
    <div id="print-area">
        <div class="print-header">
            <div>
                <img id="print-logo" src="" class="print-logo">
                <h1 id="print-empresa-nome">Marmoraria Exemplo</h1>
                <p id="print-empresa-info">CNPJ: 00.000.000/0001-00</p>
            </div>
            <div style="text-align: right;">
                <h2>OR√áAMENTO <span id="print-orcamento-id">#001</span></h2>
                <p id="print-data">Data: 01/01/2024</p>
            </div>
        </div>

        <div class="print-info-grid">
            <div class="print-section">
                <div class="print-section-title">DADOS DO CLIENTE</div>
                <p><strong>Nome:</strong> <span id="print-cliente-nome"></span></p>
                <p><strong>CPF/CNPJ:</strong> <span id="print-cliente-doc"></span></p>
                <p><strong>Telefone:</strong> <span id="print-cliente-tel"></span></p>
            </div>
            <div class="print-section">
                <div class="print-section-title">VENDEDOR</div>
                <p><strong>Nome:</strong> <span id="print-vendedor-nome"></span></p>
            </div>
        </div>

        <div class="print-section">
            <div class="print-section-title">ITENS DO OR√áAMENTO</div>
            <div class="table-responsive"><table class="table">
                <thead>
                    <tr>
                        <th>Ambiente</th>
                        <th>Medidas</th>
                        <th>Material</th>
                        <th>Prazo</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody id="print-itens-list"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" style="text-align: right; font-weight: bold; padding: 15px;">TOTAL GERAL:</td>
                        <td id="print-total-geral" style="font-weight: bold; font-size: 18px;">R$ 0,00</td>
                    </tr>
                </tfoot>
            </table></div>
        </div>

        <div style="margin-top: 50px; display: grid; grid-template-columns: 1fr 1fr; gap: 50px; text-align: center;">
            <div style="border-top: 1px solid #000; padding-top: 10px;">Assinatura do Cliente</div>
            <div style="border-top: 1px solid #000; padding-top: 10px;">Flash Marmoraria</div>
        </div>
    </div>

    <!-- MODAIS -->
    <!-- Cliente Modal -->
    <div id="modal-cliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="cliente-modal-title">Novo Cliente</h2>
                <button class="close-btn" onclick="closeModal('modal-cliente')">&times;</button>
            </div>
            <form id="form-cliente">
                <input type="hidden" id="cliente-id">
                <div class="form-group">
                    <label class="form-label">Nome / Raz√£o Social</label>
                    <input type="text" id="cliente-nome" class="form-control" required>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">CPF / CNPJ</label>
                        <input type="text" id="cliente-doc" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="text" id="cliente-tel" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Endere√ßo Completo</label>
                    <input type="text" id="cliente-endereco" class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-cliente')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vendedor Modal -->
    <div id="modal-vendedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="vendedor-modal-title">Novo Vendedor</h2>
                <button class="close-btn" onclick="closeModal('modal-vendedor')">&times;</button>
            </div>
            <form id="form-vendedor">
                <input type="hidden" id="vendedor-id">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" id="vendedor-nome" class="form-control" required>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Meta Mensal (R$)</label>
                        <input type="number" id="vendedor-meta" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comiss√£o (%)</label>
                        <input type="number" id="vendedor-comissao" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-vendedor')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Produto Modal -->
    <div id="modal-produto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="produto-modal-title">Novo Material</h2>
                <button class="close-btn" onclick="closeModal('modal-produto')">&times;</button>
            </div>
            <form id="form-produto">
                <input type="hidden" id="produto-id">
                <div class="form-group">
                    <label class="form-label">Material</label>
                    <input type="text" id="produto-material" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cor</label>
                    <input type="text" id="produto-cor" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Pre√ßo Base (m¬≤)</label>
                    <input type="number" id="produto-preco" class="form-control" step="0.01" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-produto')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chapa Modal -->
    <div id="modal-chapa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="chapa-modal-title">Nova Chapa</h2>
                <button class="close-btn" onclick="closeModal('modal-chapa')">&times;</button>
            </div>
            <form id="form-chapa">
                <input type="hidden" id="chapa-id-hidden">
                <div class="form-group">
                    <label class="form-label">ID Identificador</label>
                    <input type="text" id="chapa-identificador" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Produto</label>
                    <select id="chapa-produto-select" class="form-control" required></select>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Largura (cm)</label>
                        <input type="number" id="chapa-largura" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Altura (cm)</label>
                        <input type="number" id="chapa-altura" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-chapa')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Usuario Modal -->
    <div id="modal-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="usuario-modal-title">Novo Usu√°rio</h2>
                <button class="close-btn" onclick="closeModal('modal-usuario')">&times;</button>
            </div>
            <form id="form-usuario">
                <input type="hidden" id="usuario-id">
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" id="usuario-nome" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="usuario-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" id="usuario-senha" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Perfil</label>
                    <select id="usuario-perfil" class="form-control">
                        <option value="admin">Admin</option>
                        <option value="vendedor">Vendedor</option>
                        <option value="gerente">Gerente</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-usuario')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Empresa Modal -->
    <div id="modal-empresa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="empresa-modal-title">Nova Empresa</h2>
                <button class="close-btn" onclick="closeModal('modal-empresa')">&times;</button>
            </div>
            <form id="form-empresa">
                <input type="hidden" id="empresa-id-hidden">
                <div class="form-group">
                    <label class="form-label">Raz√£o Social</label>
                    <input type="text" id="empresa-razao" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">CNPJ</label>
                    <input type="text" id="empresa-cnpj" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Plano</label>
                    <select id="empresa-plano" class="form-control">
                        <option value="basic">Basic</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Logotipo da Empresa</label>
                    <input type="file" id="empresa-logo-input" class="form-control" accept="image/*">
                    <input type="hidden" id="empresa-logo-base64">
                    <div id="logo-preview" style="margin-top: 10px; text-align: center;">
                        <img src="" style="max-height: 60px; display: none;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-empresa')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===================== API SYSTEM =====================
        const API_URL = '/api';

        const db = {
            async getAll(table) {
                const res = await fetch(`${API_URL}/${table}`);
                return await res.json();
            },
            async getById(table, id) {
                const res = await fetch(`${API_URL}/${table}/${id}`);
                return await res.json();
            },
            async add(table, item) {
                const res = await fetch(`${API_URL}/${table}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
                const result = await res.json();
                refreshAll();
                return result;
            },
            async update(table, id, updates) {
                const res = await fetch(`${API_URL}/${table}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                const result = await res.json();
                refreshAll();
                return result;
            },
            async delete(table, id) {
                if(!confirm('Tem certeza que deseja excluir?')) return;
                await fetch(`${API_URL}/${table}/${id}`, { method: 'DELETE' });
                refreshAll();
            }
        };

        // ===================== STATE =====================
        const state = {
            currentUser: null,
            empresaId: 1,
            simulador: { pecas: [] }
        };

        // ===================== UTILS =====================
        function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active');
            const suffix = id.split('-')[1];
            const form = document.getElementById('form-' + suffix);
            if(form) form.reset();
            
            // Limpa campos ocultos de ID
            const idInput = document.getElementById(suffix + '-id');
            if(idInput) idInput.value = '';
            
            // Caso especial para empresa que usa id-hidden
            const idHidden = document.getElementById(suffix + '-id-hidden');
            if(idHidden) idHidden.value = '';
            
            // Caso especial para logo preview
            const preview = document.querySelector('#logo-preview img');
            if(preview) preview.style.display = 'none';
        }

        function showPageNav(el, pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('page-title').innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1).replace('-', ' ');
            refreshAll();
            if (window.innerWidth <= 992) toggleMobileMenu();

            if(pageId === 'simulador') {
                setTimeout(() => {
                    if(!renderer) init3D();
                    else {
                        const container = document.getElementById('visualizador-3d');
                        const w = container.clientWidth || 400;
                        const h = container.clientHeight || 300;
                        camera.aspect = w / h;
                        camera.updateProjectionMatrix();
                        renderer.setSize(w, h);
                        update3D();
                    }
                }, 100);
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // ===================== AUTH =====================
        document.getElementById('login-form').onsubmit = async function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-senha').value;
            const users = await db.getAll('usuarios');
            const user = users.find(u => u.email === email && u.senha === senha);
            if(user) {
                state.currentUser = user;
                document.getElementById('user-info').innerText = user.nome;
                updateMenuVisibility(true);
                showPageNav(document.querySelector('.nav-item[onclick*="dashboard"]'), 'dashboard');
            } else {
                alert('Login inv√°lido! Tente: admin@marmoraria.com / demo123');
            }
        };

        function logout() {
            state.currentUser = null;
            document.getElementById('user-info').innerText = 'N√£o autenticado';
            updateMenuVisibility(false);
            showPageNav(document.querySelector('.nav-item[onclick*="login"]'), 'login');
        }

        function updateMenuVisibility(isLoggedIn) {
            const navItems = document.querySelectorAll('.nav-item');
            const navSections = document.querySelectorAll('.nav-section-title');
            
            navItems.forEach(item => {
                const onclickAttr = item.getAttribute('onclick');
                const isLoginItem = onclickAttr && onclickAttr.includes("'login'");
                if (isLoggedIn) {
                    if (isLoginItem) item.classList.add('hidden');
                    else item.classList.remove('hidden');
                } else {
                    if (isLoginItem) item.classList.remove('hidden');
                    else item.classList.add('hidden');
                }
            });

            navSections.forEach(section => {
                if (isLoggedIn) section.classList.remove('hidden');
                else section.classList.add('hidden');
            });
            
            const logoutBtn = document.querySelector('button[onclick="logout()"]');
            if (logoutBtn) {
                if (isLoggedIn) logoutBtn.parentElement.classList.remove('hidden');
                else logoutBtn.parentElement.classList.add('hidden');
            }
        }

        // ===================== REFRESH FUNCTIONS =====================
        async function refreshAll() {
            if(!state.currentUser) return;
            await Promise.all([
                renderVendedores(),
                renderClientes(),
                renderProdutos(),
                renderChapas(),
                renderOrcamentos(),
                renderVendas(),
                renderProducao(),
                renderFinanceiro(),
                renderUsuarios(),
                renderEmpresas(),
                updateDashboard(),
                populateSelects()
            ]);
        }

        async function populateSelects() {
            const selects = {
                'simulador-cliente': 'clientes',
                'simulador-vendedor': 'vendedores',
                'sim-material': 'produtos',
                'chapa-produto-select': 'produtos'
            };
            for(let id in selects) {
                const el = document.getElementById(id);
                if(!el) continue;
                const items = await db.getAll(selects[id]);
                el.innerHTML = '<option value="">Selecione...</option>' + 
                    items.map(i => `<option value="${i.id}">${i.nome || i.nomeRazao || (i.material + ' ' + i.cor)}</option>`).join('');
            }
        }

        // ===================== CRUD RENDERS & ACTIONS =====================
        
        async function renderVendedores() {
            const list = document.getElementById('vendedores-list');
            if(!list) return;
            const items = await db.getAll('vendedores');
            list.innerHTML = items.map(v => `
                <tr>
                    <td>${v.nome}</td>
                    <td>${formatCurrency(v.metaMensal || 0)}</td>
                    <td>${v.comissao}%</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editVendedor('${v.id}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="db.delete('vendedores', '${v.id}')">Deletar</button>
                    </td>
                </tr>
            `).join('');
        }
        async function editVendedor(id) {
            const v = await db.getById('vendedores', id);
            document.getElementById('vendedor-id').value = v.id;
            document.getElementById('vendedor-nome').value = v.nome;
            document.getElementById('vendedor-meta').value = v.metaMensal;
            document.getElementById('vendedor-comissao').value = v.comissao;
            openModal('modal-vendedor');
        }
        document.getElementById('form-vendedor').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('vendedor-id').value;
            const data = {
                nome: document.getElementById('vendedor-nome').value,
                metaMensal: parseFloat(document.getElementById('vendedor-meta').value),
                comissao: parseFloat(document.getElementById('vendedor-comissao').value)
            };
            id ? await db.update('vendedores', id, data) : await db.add('vendedores', data);
            closeModal('modal-vendedor');
        };

        async function renderClientes() {
            const list = document.getElementById('clientes-list');
            if(!list) return;
            const items = await db.getAll('clientes');
            list.innerHTML = items.map(c => `
                <tr>
                    <td>${c.nomeRazao}</td>
                    <td>${c.cpfCnpj}</td>
                    <td>${c.tel}</td>
                    <td>${c.endereco || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCliente('${c.id}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="db.delete('clientes', '${c.id}')">Deletar</button>
                    </td>
                </tr>
            `).join('');
        }
        async function editCliente(id) {
            const c = await db.getById('clientes', id);
            document.getElementById('cliente-id').value = c.id;
            document.getElementById('cliente-nome').value = c.nomeRazao;
            document.getElementById('cliente-doc').value = c.cpfCnpj;
            document.getElementById('cliente-tel').value = c.tel;
            document.getElementById('cliente-endereco').value = c.endereco;
            openModal('modal-cliente');
        }
        document.getElementById('form-cliente').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('cliente-id').value;
            const data = {
                nomeRazao: document.getElementById('cliente-nome').value,
                cpfCnpj: document.getElementById('cliente-doc').value,
                tel: document.getElementById('cliente-tel').value,
                endereco: document.getElementById('cliente-endereco').value
            };
            id ? await db.update('clientes', id, data) : await db.add('clientes', data);
            closeModal('modal-cliente');
        };

        async function renderProdutos() {
            const list = document.getElementById('produtos-list');
            if(!list) return;
            const items = await db.getAll('produtos');
            list.innerHTML = items.map(p => `
                <tr>
                    <td>${p.material}</td>
                    <td>${p.cor}</td>
                    <td>${formatCurrency(p.precoBase)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editProduto('${p.id}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="db.delete('produtos', '${p.id}')">Deletar</button>
                    </td>
                </tr>
            `).join('');
        }
        async function editProduto(id) {
            const p = await db.getById('produtos', id);
            document.getElementById('produto-id').value = p.id;
            document.getElementById('produto-material').value = p.material;
            document.getElementById('produto-cor').value = p.cor;
            document.getElementById('produto-preco').value = p.precoBase;
            openModal('modal-produto');
        }
        document.getElementById('form-produto').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('produto-id').value;
            const data = {
                material: document.getElementById('produto-material').value,
                cor: document.getElementById('produto-cor').value,
                precoBase: parseFloat(document.getElementById('produto-preco').value)
            };
            id ? await db.update('produtos', id, data) : await db.add('produtos', data);
            closeModal('modal-produto');
        };

        // VISUALIZADOR 3D
        let scene, camera, renderer, controls;
        let objects3D = [];

        function init3D() {
            const container = document.getElementById('visualizador-3d');
            if (!container) return;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(2, 2, 2);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            const width = container.clientWidth || 400;
            const height = container.clientHeight || 300;
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            window.addEventListener('resize', () => {
                const w = container.clientWidth;
                const h = container.clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            });

            // Controles de √ìrbita
            if (window.THREE.OrbitControls) {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
            }

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0xffffff, 0.5);
            pointLight.position.set(-5, 5, -5);
            scene.add(pointLight);

            // Ch√£o para refer√™ncia
            const gridHelper = new THREE.GridHelper(10, 10);
            scene.add(gridHelper);

            animate3D();
            update3D();
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        function update3D() {
            if (!scene) return;

            // Limpar objetos anteriores
            objects3D.forEach(obj => scene.remove(obj));
            objects3D = [];

            const largura = parseFloat(document.getElementById('sim-largura').value) || 0.5;
            const profundidade = parseFloat(document.getElementById('sim-altura').value) || 0.5;
            const espessura = 0.02; 

            // Material simulando pedra
            const material3D = new THREE.MeshStandardMaterial({ 
                color: 0x888888, 
                roughness: 0.4,
                metalness: 0.1
            });

            // Grupo para centralizar a pe√ßa
            const pecaGroup = new THREE.Group();

            // Tampo
            const tampoGeo = new THREE.BoxGeometry(largura, espessura, profundidade);
            const tampo = new THREE.Mesh(tampoGeo, material3D);
            tampo.position.y = 0.90; 
            tampo.castShadow = true;
            tampo.receiveShadow = true;
            pecaGroup.add(tampo);

            // Bordas
            const numBordas = parseInt(document.getElementById('sim-bordas').value) || 0;
            for (let i = 1; i <= numBordas; i++) {
                const l = parseFloat(document.getElementById(`sim-bordas-${i}-l`)?.value) || largura;
                const h = parseFloat(document.getElementById(`sim-bordas-${i}-h`)?.value) || 0.04;
                const bordaGeo = new THREE.BoxGeometry(l, h, 0.02);
                const borda = new THREE.Mesh(bordaGeo, material3D);
                
                if (i === 1) borda.position.set(0, 0.90 - h/2, profundidade/2 + 0.01);
                if (i === 2) borda.position.set(0, 0.90 - h/2, -profundidade/2 - 0.01);
                if (i === 3) { borda.rotation.y = Math.PI/2; borda.position.set(largura/2 + 0.01, 0.90 - h/2, 0); }
                if (i === 4) { borda.rotation.y = Math.PI/2; borda.position.set(-largura/2 - 0.01, 0.90 - h/2, 0); }
                
                borda.castShadow = true;
                pecaGroup.add(borda);
            }

            // Front√µes
            const numFrontoes = parseInt(document.getElementById('sim-frontoes').value) || 0;
            for (let i = 1; i <= numFrontoes; i++) {
                const l = parseFloat(document.getElementById(`sim-frontoes-${i}-l`)?.value) || largura;
                const h = parseFloat(document.getElementById(`sim-frontoes-${i}-h`)?.value) || 0.10;
                const frontaoGeo = new THREE.BoxGeometry(l, h, 0.02);
                const frontao = new THREE.Mesh(frontaoGeo, material3D);
                
                if (i === 1) frontao.position.set(0, 0.90 + espessura/2 + h/2, -profundidade/2 - 0.01);
                if (i === 2) { frontao.rotation.y = Math.PI/2; frontao.position.set(-largura/2 - 0.01, 0.90 + espessura/2 + h/2, 0); }
                if (i === 3) { frontao.rotation.y = Math.PI/2; frontao.position.set(largura/2 + 0.01, 0.90 + espessura/2 + h/2, 0); }
                
                frontao.castShadow = true;
                pecaGroup.add(frontao);
            }

            // P√©s
            const numPes = parseInt(document.getElementById('sim-pes').value) || 0;
            for (let i = 1; i <= numPes; i++) {
                const l = parseFloat(document.getElementById(`sim-pes-${i}-l`)?.value) || profundidade;
                const h = parseFloat(document.getElementById(`sim-pes-${i}-h`)?.value) || 0.90;
                const peGeo = new THREE.BoxGeometry(0.02, h, l);
                const pe = new THREE.Mesh(peGeo, material3D);
                
                if (i === 1) pe.position.set(-largura/2 + 0.01, h/2, 0);
                if (i === 2) pe.position.set(largura/2 - 0.01, h/2, 0);
                
                pe.castShadow = true;
                pecaGroup.add(pe);

                // Bordas nos p√©s
                const qBordasPe = parseInt(document.getElementById(`sim-pe-${i}-bordas`)?.value) || 0;
                for(let j=1; j<=qBordasPe; j++) {
                    const bPeGeo = new THREE.BoxGeometry(0.02, h, 0.02);
                    const bPe = new THREE.Mesh(bPeGeo, material3D);
                    if (i === 1) bPe.position.set(-largura/2 + 0.03, h/2, (j === 1 ? l/2 : -l/2));
                    if (i === 2) bPe.position.set(largura/2 - 0.03, h/2, (j === 1 ? l/2 : -l/2));
                    pecaGroup.add(bPe);
                }
            }

            scene.add(pecaGroup);
            objects3D.push(pecaGroup);

            // Ajustar c√¢mera para focar na pe√ßa
            const box = new THREE.Box3().setFromObject(pecaGroup);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z, 1);
            
            if (controls) {
                controls.target.copy(center);
                camera.position.set(center.x + maxDim, center.y + maxDim, center.z + maxDim);
            }
        }

        // SIMULADOR
        function gerarCamposIndividuais(tipo) {
            const qtd = parseInt(document.getElementById(`sim-${tipo}`).value) || 0;
            const container = document.getElementById(`container-${tipo}-individuais`);
            container.innerHTML = '';
            
            const larguraPeca = parseFloat(document.getElementById('sim-largura').value) || 0;
            const alturaPeca = parseFloat(document.getElementById('sim-altura').value) || 0;

            for (let i = 1; i <= qtd; i++) {
                let labelL = 'Largura (m)';
                let labelH = 'Altura (m)';
                let valL = '';
                let valH = '';
                let extraHtml = '';

                if (tipo === 'bordas') {
                    labelL = `Largura Borda ${i}`;
                    labelH = `Altura/Saia ${i}`;
                    valL = larguraPeca;
                    valH = 0.04;
                } else if (tipo === 'frontoes') {
                    labelL = `Largura Front√£o ${i}`;
                    labelH = `Altura Front√£o ${i}`;
                    valL = larguraPeca;
                    valH = 0.10;
                } else if (tipo === 'pes') {
                    labelL = `Largura P√© ${i}`;
                    labelH = `Altura P√© ${i}`;
                    valL = alturaPeca;
                    valH = 0.90;
                    // Adicionar op√ß√£o de borda para cada p√© individualmente
                    extraHtml = `
                        <div class="form-group" style="grid-column: span 3;">
                            <label class="form-label">Bordas neste P√© (Qtd)</label>
                            <select id="sim-pe-${i}-bordas" class="form-control" onchange="update3D()">
                                <option value="0">Nenhuma</option>
                                <option value="1">1 Borda</option>
                                <option value="2">2 Bordas</option>
                            </select>
                        </div>
                    `;
                }

                container.innerHTML += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 10px; background: rgba(0,0,0,0.02); border-radius: 4px; border: 1px solid rgba(0,0,0,0.05);">
                        <div style="grid-column: span 3; font-size: 11px; font-weight: bold; text-transform: uppercase; color: var(--color-text-light);">${tipo.slice(0, -1)} ${i}</div>
                        <div class="form-group">
                            <label class="form-label">${labelL}</label>
                            <input type="number" id="sim-${tipo}-${i}-l" class="form-control" step="0.01" value="${valL}" placeholder="Auto" oninput="update3D()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">${labelH}</label>
                            <input type="number" id="sim-${tipo}-${i}-h" class="form-control" step="0.01" value="${valH}" oninput="update3D()">
                        </div>
                        ${extraHtml}
                    </div>
                `;
            }
        }

        async function adicionarPeca() {
            const materialId = document.getElementById('sim-material').value;
            const material = (await db.getAll('produtos')).find(p => p.id == materialId);
            if(!material) return alert('Selecione um material!');
            
            const largura = parseFloat(document.getElementById('sim-largura').value) || 0;
            const altura = parseFloat(document.getElementById('sim-altura').value) || 0;
            const qtd = parseInt(document.getElementById('sim-qtd').value) || 1;
            const numBordas = parseInt(document.getElementById('sim-bordas').value) || 0;
            const numFrontoes = parseInt(document.getElementById('sim-frontoes').value) || 0;
            const numPes = parseInt(document.getElementById('sim-pes').value) || 0;
            
            if(largura <= 0 || altura <= 0) return alert('Informe as medidas da pe√ßa!');

            let areaBordas = 0;
            let comprimentoBordas = 0;
            let listaBordas = [];
            for(let i=1; i<=numBordas; i++) {
                const l = parseFloat(document.getElementById(`sim-bordas-${i}-l`).value) || largura;
                const h = parseFloat(document.getElementById(`sim-bordas-${i}-h`).value) || 0.04;
                areaBordas += (l * h);
                comprimentoBordas += l;
                listaBordas.push({ l, h });
            }

            let areaFrontoes = 0;
            let listaFrontoes = [];
            for(let i=1; i<=numFrontoes; i++) {
                const l = parseFloat(document.getElementById(`sim-frontoes-${i}-l`).value) || largura;
                const h = parseFloat(document.getElementById(`sim-frontoes-${i}-h`).value) || 0.10;
                areaFrontoes += (l * h);
                listaFrontoes.push({ l, h });
            }

            let areaPes = 0;
            let areaPeBordas = 0;
            let comprimentoPeBordas = 0;
            let listaPes = [];
            for(let i=1; i<=numPes; i++) {
                const l = parseFloat(document.getElementById(`sim-pes-${i}-l`).value) || altura;
                const h = parseFloat(document.getElementById(`sim-pes-${i}-h`).value) || 0.90;
                const qBordas = parseInt(document.getElementById(`sim-pe-${i}-bordas`).value) || 0;
                
                areaPes += (l * h);
                
                // Borda do p√©: largura da borda √© a altura do p√© (h), altura da borda √© padr√£o (0.04)
                const peBordaL = h; 
                const peBordaH = 0.04; 
                areaPeBordas += (qBordas * peBordaL * peBordaH);
                comprimentoPeBordas += (qBordas * peBordaL);
                
                listaPes.push({ l, h, qBordas });
            }

            const areaTampo = largura * altura;
            const areaTotal = areaTampo + areaBordas + areaFrontoes + areaPes + areaPeBordas;
            
            // Acabamento Linear (M√£o de obra)
            const custoAcabamentoLinear = (material.precoBase * 0.15) * (comprimentoBordas + comprimentoPeBordas);

            const subtotal = (areaTotal * material.precoBase * qtd) + (custoAcabamentoLinear * qtd);

            const peca = {
                id: Date.now(),
                ambiente: document.getElementById('sim-ambiente').value || 'Geral',
                material: material.material + ' ' + material.cor,
                largura,
                altura,
                qtd,
                numBordas,
                numFrontoes,
                numPes,
                detalhes_tecnicos: {
                    bordas: listaBordas,
                    frontoes: listaFrontoes,
                    pes: listaPes
                },
                precoM2: material.precoBase,
                subtotal: subtotal,
                detalhes: `${numBordas} bordas, ${numFrontoes} front√µes, ${numPes} p√©s (com medidas individualizadas)`
            };
            peca.medidas = `${largura}x${altura}m`;
            
            state.simulador.pecas.push(peca);
            renderSimulador();
            
            // Limpar campos ap√≥s adicionar
            document.getElementById('sim-ambiente').value = '';
            document.getElementById('sim-largura').value = '';
            document.getElementById('sim-altura').value = '';
            document.getElementById('sim-qtd').value = '1';
            document.getElementById('sim-bordas').value = '0';
            document.getElementById('sim-frontoes').value = '0';
            document.getElementById('sim-pes').value = '0';
            gerarCamposIndividuais('bordas');
            gerarCamposIndividuais('frontoes');
            gerarCamposIndividuais('pes');
        }

        function renderSimulador() {
            const list = document.getElementById('simulador-itens');
            list.innerHTML = state.simulador.pecas.map(p => `
                <tr>
                    <td>${p.ambiente}</td>
                    <td>
                        <strong>${p.medidas}</strong> (${p.qtd}x)<br>
                        <small style="color: var(--color-text-light)">${p.detalhes}</small>
                    </td>
                    <td>${p.material}</td>
                    <td>${formatCurrency(p.subtotal)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removerPeca(${p.id})">Remover</button></td>
                </tr>
            `).join('');
            const total = state.simulador.pecas.reduce((acc, p) => acc + p.subtotal, 0);
            document.getElementById('simulador-total').innerText = formatCurrency(total);
        }

        function removerPeca(id) {
            state.simulador.pecas = state.simulador.pecas.filter(p => p.id !== id);
            renderSimulador();
        }

        async function gerarOrcamento() {
            const clienteId = document.getElementById('simulador-cliente').value;
            const vendedorId = document.getElementById('simulador-vendedor').value;
            if(!clienteId || !vendedorId || state.simulador.pecas.length === 0) return alert('Preencha todos os dados!');
            
            const total = state.simulador.pecas.reduce((acc, p) => acc + p.subtotal, 0);
            await db.add('orcamentos', { 
                clienteId, 
                vendedorId, 
                total, 
                pecas: JSON.stringify(state.simulador.pecas),
                status: 'pendente', 
                data: new Date().toLocaleDateString() 
            });
            
            state.simulador.pecas = [];
            renderSimulador();
            alert('Or√ßamento gerado com sucesso!');
            showPageNav(null, 'orcamentos');
        }

        async function renderOrcamentos() {
            const list = document.getElementById('orcamentos-list');
            if(!list) return;
            const orcamentos = await db.getAll('orcamentos');
            const clientes = await db.getAll('clientes');
            list.innerHTML = orcamentos.map(o => {
                const c = clientes.find(cli => cli.id == o.clienteId);
                return `
                <tr>
                    <td>${o.id}</td>
                    <td>${o.data}</td>
                    <td>${c ? c.nomeRazao : 'N/A'}</td>
                    <td>${formatCurrency(o.total)}</td>
                    <td><span class="badge badge-warning">${o.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="imprimirOrcamento('${o.id}')">üñ®Ô∏è Imprimir</button>
                        ${o.status === 'pendente' ? `<button class="btn btn-sm btn-primary" onclick="aprovarOrcamento('${o.id}')">Aprovar</button>` : ''}
                        <button class="btn btn-sm btn-danger" onclick="db.delete('orcamentos', '${o.id}')">Deletar</button>
                    </td>
                </tr>
            `}).join('');
        }

        async function imprimirOrcamento(id) {
            const o = await db.getById('orcamentos', id);
            const c = await db.getById('clientes', o.clienteId);
            const v = await db.getById('vendedores', o.vendedorId);
            const empresas = await db.getAll('empresas');
            const emp = empresas[0];

            document.getElementById('print-empresa-nome').innerText = emp ? emp.razaoSocial : 'Marmoraria Exemplo';
            document.getElementById('print-empresa-info').innerText = emp ? `CNPJ: ${emp.cnpj}` : '';
            
            const printLogo = document.getElementById('print-logo');
            if (emp && emp.logo) {
                printLogo.src = emp.logo;
                printLogo.style.display = 'block';
            } else {
                printLogo.style.display = 'none';
            }

            document.getElementById('print-orcamento-id').innerText = `#${o.id}`;
            document.getElementById('print-data').innerText = `Data: ${o.data}`;
            document.getElementById('print-cliente-nome').innerText = c ? c.nomeRazao : 'N/A';
            document.getElementById('print-cliente-doc').innerText = c ? c.cpfCnpj : 'N/A';
            document.getElementById('print-cliente-tel').innerText = c ? c.tel : 'N/A';
            document.getElementById('print-vendedor-nome').innerText = v ? v.nome : 'N/A';

            const pecas = typeof o.pecas === 'string' ? JSON.parse(o.pecas) : o.pecas;
            const itensList = document.getElementById('print-itens-list');
            if (pecas && pecas.length > 0) {
                itensList.innerHTML = pecas.map(p => `
                    <tr>
                        <td>${p.ambiente}</td>
                        <td>${p.medidas}</td>
                        <td>${p.material || 'Marmoraria'}</td>
                        <td>A definir</td>
                        <td>${formatCurrency(p.subtotal)}</td>
                    </tr>
                `).join('');
            } else {
                itensList.innerHTML = `<tr><td colspan="4">Servi√ßos de Marmoraria conforme projeto</td><td>${formatCurrency(o.total)}</td></tr>`;
            }

            document.getElementById('print-total-geral').innerText = formatCurrency(o.total);
            window.print();
        }

        async function aprovarOrcamento(id) {
            const o = await db.getById('orcamentos', id);
            await db.update('orcamentos', id, { status: 'aprovado' });
            
            await db.add('vendas', {
                orcamentoId: id,
                clienteId: o.clienteId,
                vendedorId: o.vendedorId,
                total: o.total,
                dataOrcamento: o.data,
                dataVenda: new Date().toISOString().split('T')[0],
                dataVendaFormatada: new Date().toLocaleDateString()
            });

            await db.add('pedidos', { orcamentoId: id, status: 'em_producao', total: o.total });
            await db.add('osProducao', { pedidoId: id, status: 'aguardando', previsao: 'A definir' });
            await db.add('contasReceber', { clienteId: o.clienteId, valor: o.total, status: 'aberto', vencimento: '30 dias' });
            alert('Or√ßamento aprovado! Venda registrada e Financeiro gerado.');
            refreshAll();
        }

        async function renderVendas() {
            const list = document.getElementById('vendas-list');
            if(!list) return;
            const vendas = await db.getAll('vendas');
            const clientes = await db.getAll('clientes');
            const vendedores = await db.getAll('vendedores');
            list.innerHTML = vendas.map(v => {
                const c = clientes.find(cli => cli.id == v.clienteId);
                const ven = vendedores.find(vend => vend.id == v.vendedorId);
                return `
                <tr>
                    <td>${v.dataVendaFormatada}</td>
                    <td>${v.dataOrcamento}</td>
                    <td>${c ? c.nomeRazao : 'N/A'}</td>
                    <td>${ven ? ven.nome : 'N/A'}</td>
                    <td>${formatCurrency(v.total)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="imprimirOrcamento('${v.orcamentoId}')">üñ®Ô∏è Recibo</button>
                    </td>
                </tr>
            `}).join('');
        }

        async function renderProducao() {
            const list = document.getElementById('producao-list');
            if(!list) return;
            const os = await db.getAll('osProducao');
            list.innerHTML = os.map(o => `
                <tr>
                    <td>${o.id}</td>
                    <td>${o.pedidoId}</td>
                    <td><span class="badge badge-info">${o.status}</span></td>
                    <td>${o.previsao}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="db.update('osProducao', '${o.id}', {status: 'concluido'})">Concluir</button>
                    </td>
                </tr>
            `).join('');
        }

        async function renderFinanceiro() {
            const rec = document.getElementById('receber-list');
            const clientes = await db.getAll('clientes');
            if(rec) {
                const items = await db.getAll('contasReceber');
                rec.innerHTML = items.map(r => {
                    const c = clientes.find(cli => cli.id == r.clienteId);
                    return `
                    <tr>
                        <td>${c ? c.nomeRazao : 'N/A'}</td>
                        <td>${r.vencimento}</td>
                        <td>${formatCurrency(r.valor)}</td>
                        <td><span class="badge badge-warning">${r.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="db.update('contasReceber', '${r.id}', {status: 'pago'})">Baixar</button></td>
                    </tr>
                `}).join('');
            }

            const pag = document.getElementById('pagar-list');
            if(pag) {
                const items = await db.getAll('contasPagar');
                pag.innerHTML = items.map(p => `
                    <tr>
                        <td>${p.fornecedor}</td>
                        <td>${p.vencimento}</td>
                        <td>${formatCurrency(p.valor)}</td>
                        <td><span class="badge badge-danger">${p.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="db.update('contasPagar', '${p.id}', {status: 'pago'})">Pagar</button></td>
                    </tr>
                `).join('');
            }
        }

        async function openContaPagarModal() {
            const forn = prompt('Fornecedor:');
            const valor = prompt('Valor:');
            if(forn && valor) await db.add('contasPagar', { fornecedor: forn, valor: parseFloat(valor), vencimento: 'A definir', status: 'aberto' });
        }

        function openUsuarioModal() {
            document.getElementById('usuario-id').value = '';
            document.getElementById('form-usuario').reset();
            document.getElementById('usuario-modal-title').innerText = 'Novo Usu√°rio';
            openModal('modal-usuario');
        }

        async function renderUsuarios() {
            const list = document.getElementById('usuarios-list');
            if(!list) return;
            const items = await db.getAll('usuarios');
            list.innerHTML = items.map(u => `
                <tr>
                    <td>${u.nome}</td>
                    <td>${u.email}</td>
                    <td>${u.perfil}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editUsuario('${u.id}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="db.delete('usuarios', '${u.id}')">Deletar</button>
                    </td>
                </tr>
            `).join('');
        }
        async function editUsuario(id) {
            const u = await db.getById('usuarios', id);
            document.getElementById('usuario-id').value = u.id;
            document.getElementById('usuario-nome').value = u.nome;
            document.getElementById('usuario-email').value = u.email;
            document.getElementById('usuario-senha').value = u.senha;
            document.getElementById('usuario-perfil').value = u.perfil;
            openModal('modal-usuario');
        }
        document.getElementById('form-usuario').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('usuario-id').value;
            const data = {
                nome: document.getElementById('usuario-nome').value,
                email: document.getElementById('usuario-email').value,
                senha: document.getElementById('usuario-senha').value,
                perfil: document.getElementById('usuario-perfil').value
            };
            try {
                if (id) {
                    await db.update('usuarios', id, data);
                    alert('Usu√°rio atualizado com sucesso!');
                } else {
                    await db.add('usuarios', data);
                    alert('Usu√°rio cadastrado com sucesso!');
                }
                closeModal('modal-usuario');
                renderUsuarios();
            } catch (err) {
                console.error(err);
                alert('Erro ao salvar usu√°rio.');
            }
        };

        document.getElementById('form-empresa').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('empresa-id-hidden').value;
            const data = {
                razaoSocial: document.getElementById('empresa-razao').value,
                cnpj: document.getElementById('empresa-cnpj').value,
                planoSaas: document.getElementById('empresa-plano').value,
                logo: document.getElementById('empresa-logo-base64').value
            };
            id ? await db.update('empresas', id, data) : await db.add('empresas', data);
            closeModal('modal-empresa');
        };

        async function renderEmpresas() {
            const list = document.getElementById('empresas-list');
            if(!list) return;
            const items = await db.getAll('empresas');
            list.innerHTML = items.map(e => `
                <tr>
                    <td>${e.razaoSocial}</td>
                    <td>${e.cnpj}</td>
                    <td>${e.planoSaas || 'premium'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="db.delete('empresas', '${e.id}')">Deletar</button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateDashboard() {
            const vendas = await db.getAll('vendas');
            const orcamentos = await db.getAll('orcamentos');
            const producao = await db.getAll('osProducao');
            const receber = await db.getAll('contasReceber');
            const clientes = await db.getAll('clientes');

            const totalVendas = vendas.reduce((acc, v) => acc + v.total, 0);
            const totalReceber = receber.filter(r => r.status === 'aberto').reduce((acc, r) => acc + r.valor, 0);

            document.getElementById('kpi-vendas-mes').innerText = formatCurrency(totalVendas);
            document.getElementById('kpi-orc-pendentes').innerText = orcamentos.filter(o => o.status === 'pendente').length;
            document.getElementById('kpi-producao').innerText = producao.filter(p => p.status !== 'concluido').length;
            document.getElementById('kpi-receber').innerText = formatCurrency(totalReceber);

            const dashOrc = document.getElementById('dash-orcamentos');
            dashOrc.innerHTML = orcamentos.slice(-5).reverse().map(o => {
                const c = clientes.find(cli => cli.id == o.clienteId);
                return `
                <tr>
                    <td>${o.data}</td>
                    <td>${c ? c.nomeRazao : 'N/A'}</td>
                    <td>${formatCurrency(o.total)}</td>
                    <td><span class="badge badge-info">${o.status}</span></td>
                </tr>
            `}).join('');
        }

        async function renderChapas() {
            const list = document.getElementById('chapas-list');
            if(!list) return;
            const chapas = await db.getAll('chapas');
            const produtos = await db.getAll('produtos');
            list.innerHTML = chapas.map(c => {
                const p = produtos.find(prod => prod.id == c.produtoId);
                const area = (c.largura * c.altura) / 10000;
                return `
                <tr>
                    <td>${c.identificadorChapa}</td>
                    <td>${p ? p.material : 'N/A'}</td>
                    <td>${c.largura}x${c.altura}</td>
                    <td>${area.toFixed(2)} m¬≤</td>
                    <td><span class="badge badge-success">${c.status}</span></td>
                    <td><button class="btn btn-sm btn-danger" onclick="db.delete('chapas', '${c.id}')">Deletar</button></td>
                </tr>
            `}).join('');
        }

        // Inicializa√ß√£o
        window.onload = async () => {
            // Criar usu√°rio admin padr√£o se n√£o existir
            const users = await db.getAll('usuarios');
            if(users.length === 0) {
                await db.add('usuarios', { nome: 'Admin', email: 'admin@marmoraria.com', senha: 'demo123', perfil: 'admin' });
            }
            showPageNav(null, 'login');
            init3D();
        };
    </script>
</body>
</html>
